---
title: "Thesis Analysis"
author: "Rory Butler"
date: "4/02/2022"
output: 
  html_document:
    keep_md: true
    toc: true
---
```{r global options, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(include=TRUE, warning=FALSE, message=FALSE, echo=FALSE)
```

## Pulling in all the data and transforming as needed
The food atlas data needs to be restricted to Colorado only
Shape file shouldn't need to be restricted

Poverty data we only need to keep poverty % value for each census tract
Education will need to transform into fewer categories and ultimately use just one split (college or not, probably)
Geographic mobility will transform into moved or didn't move
Race will transform into white % only (white vs non white essentially)

All the ACS files have a lead-in to the Census Tract # that differs from the atlas and obesity files

All the files give a raw number instead of a percentage; we pull in the population data too

```{r Pull in all data}
library(tidyverse)
library(rgdal)
library(sf)
atlas <- read_csv('food_access_research_atlas.csv')
obesity_shape <- readOGR(".", "Obesity_in_Adults_-_CDPHE_Community_Level_Estimates_(Census_Tracts)")
race <- read_csv('ACS_2019_race.csv')
mobility <- read_csv('ACS_2019_mobility.csv')
education <- read_csv('ACS_2019_education.csv')
poverty <- read_csv('ACS_2019_poverty.csv')
pop <- read_csv('ACS_2019_population.csv')
```
The data manipulation step will join together the ACS data all using the population dataframe as the basis. Afterwards we'll create the ratios - variables divided by the overall population. Also will then rename the geoid column after all the joins. This is so it is consistent with the other two files; easier to rename only once after doing all the joins
```{r manipulate & combine data}
library(dplyr)
names(pop)[names(pop) == 'B01003_001E'] <- "population"
pop <- pop %>%
  select(GEO_ID, NAME, population)

# this field indicates how many people are in the same household as the previous year
names(mobility)[names(mobility) == 'B07003_004E'] <- "unmoved"

mobility <- mobility %>%
  select(GEO_ID, unmoved)


# this field indicates how many people were under the poverty line
names(poverty)[names(poverty) == 'B17001_002E'] <- "poverty"

poverty <- poverty %>%
  select(GEO_ID, poverty)


# field indicating count of all white-only individuals
names(race)[names(race) == 'B03002_003E'] <- "white"

race <- race %>%
  select(GEO_ID, white)

# create variables that find how many people graduated HS or have a bachelor's degree
educ2 <- education %>%
  rowwise() %>%
  mutate(hs_education = sum(c(B15003_017E, B15003_018E, B15003_019E, B15003_020E, B15003_021E, B15003_022E, B15003_023E, B15003_024E, B15003_025E))) %>%
  mutate(bachelors_degree = sum(c(B15003_022E, B15003_023E, B15003_024E, B15003_025E)))

educ2 <- educ2 %>%
  select(GEO_ID, hs_education, bachelors_degree)

# begin merging the datasets
pop2 <- merge(pop, mobility, by = "GEO_ID")

pop3 <- merge(pop2, poverty, by = "GEO_ID")

pop4 <- merge(pop3, race, by = "GEO_ID")

acs_pop <- merge(pop4, educ2, by = "GEO_ID")

acs_pop$unmoved_pct <- (acs_pop$unmoved / acs_pop$population)
acs_pop$poverty_pct <- (acs_pop$poverty / acs_pop$population)
acs_pop$minority_pct <- (1 - (acs_pop$white / acs_pop$population))
acs_pop$hs_education_pct <- (acs_pop$hs_education / acs_pop$population)
acs_pop$bachelors_degree_pct <- (acs_pop$bachelors_degree / acs_pop$population)

acs_pop <- acs_pop %>%
  mutate(GEO_ID = substr(GEO_ID, nchar(GEO_ID)-11+1, nchar(GEO_ID)))

acs_pop
```
```{r merge food desert data}
#atlas <- atlas %>%
#  filter(State == 'Colorado') %>%
#  select(CensusTract, LA1and10, LAPOP1_10)

atlas
  
acs_pop_w_deserts <- merge(acs_pop, atlas, by.x = "GEO_ID", by.y = "CensusTract")

acs_pop_w_deserts

acs_pop_w_deserts$food_desert_pct <- (acs_pop$LAPOP_10 / acs_pop_w_deserts$population)

final_shape <- merge(obesity_shape, acs_pop_w_deserts, by.x = "Census_Tra", by.y ="GEO_ID")

#normalize as percentage
final_shape$Obese_Cens <- (final_shape$Obese_Cens / 100)

# no missing data points!
sum(is.na(final_shape$population))

writeOGR(final_shape, ".", "CO_Obesity", driver="ESRI Shapefile")
```
```{r population visualization}
library(leaflet)
library(htmltools)
#bins <-c(0,100,200,500,1000,1500,2000,2500,3000,3500,4000)
pal <-colorBin("YlOrRd", domain=final_shape$population)

labels <- sprintf(
  "<strong>%s</strong><br/>Population: %g",
  final_shape$Census_Tra, final_shape$population
) %>% lapply(htmltools::HTML)


leaflet(final_shape) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal(population),
    weight = 2,
    opacity = 1,
    color = "gray",
    fillOpacity = 0.8,
    highlightOptions = highlightOptions(
    weight = 5,
    color = "#666",
    fillOpacity = 0.8),
    label = labels,
    labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "15px",
                                          direction = "auto")) %>%
  addLegend(pal=pal, values = ~population, opacity = 0.8, title = "Population by Census Tract")
```
```{r t}
head(final_shape)
```
```{r visu 2}
bins <-c(0,0.1,0.2,0.3,0.4,1)
pal <-colorBin("YlOrRd", domain=final_shape$Obese_Cens, bins)

labels <- sprintf(
  "<strong>%s</strong><br/>Population: %g",
  final_shape$Census_Tra, final_shape$Obese_Cens
) %>% lapply(htmltools::HTML)


leaflet(final_shape) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal(Obese_Cens),
    weight = 2,
    opacity = 1,
    color = "gray",
    fillOpacity = 0.8,
    highlightOptions = highlightOptions(
    weight = 5,
    color = "#666",
    fillOpacity = 0.8),
    label = labels,
    labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "15px",
                                          direction = "auto")) %>%
  addLegend(pal=pal, values = ~Obese_Cens, opacity = 0.8, title = "Obesity Percentage by Census Tract")
```
```{r analysis time}
```